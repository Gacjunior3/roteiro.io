<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roteirizador de Viagens</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Adicionando html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Seus estilos permanecem os mesmos */
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --dark: #1b263b;
            --light: #f8f9fa;
            --success: #4cc9f0;
            --warning: #f72585;
            --gray: #adb5bd;
            --white: #ffffff;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 1rem;
        }
        .logo i {
            font-size: 2rem;
        }
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }
        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 500;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .card-title {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-title i {
            font-size: 1.2rem;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }
        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray);
            border-radius: 6px;
            font-family: 'Poppins', sans-serif;
            transition: border 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
        }
        .btn-danger {
            background-color: var(--warning);
            color: white;
        }
        .btn-danger:hover {
            background-color: #d91a6a;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: var(--gray);
            color: white;
        }
        .btn-secondary:hover {
            background-color: #8d99ae;
            transform: translateY(-2px);
        }
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        .btn-success:hover {
            background-color: #3aa8d0;
            transform: translateY(-2px);
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        .btn-info:hover {
            background-color: #138496;
            transform: translateY(-2px);
        }
        .error {
            color: var(--warning);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: block;
        }
        .veiculo-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary);
        }
        .veiculo-title {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .viagem-type {
            font-size: 1rem;
            margin: 1.5rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray);
            color: var(--primary);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }
        th {
            background-color: var(--primary);
            color: white;
            padding: 0.75rem;
            text-align: left;
        }
        td {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #e9ecef;
        }
        .total {
            font-weight: 600;
            text-align: right;
            font-size: 1.1rem;
            margin-top: 1rem;
            color: var(--dark);
        }
        .hidden {
            display: none;
        }
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--gray);
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .action-btn {
            padding: 0.35rem 0.5rem;
            font-size: 0.8rem;
            border-radius: 4px;
        }
        .edit-form {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #eee;
        }
        .filter-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .filter-title {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            .form-group {
                margin-bottom: 1rem;
            }
            .tabs {
                flex-direction: column;
            }
            .action-buttons {
                flex-direction: column;
            }
            .action-btn {
                width: 100%;
            }
            .export-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-truck-moving"></i>
                <h1>Roteirizador de Viagens</h1>
            </div>
            <p>Controle completo das viagens da sua frota</p>
        </header>

        <div class="tabs">
            <div class="tab active" onclick="showTab('form')">
                <i class="fas fa-plus-circle"></i> Nova Viagem
            </div>
            <div class="tab" onclick="showTab('results')">
                <i class="fas fa-list-ul"></i> Visualizar Roteiros
            </div>
        </div>

        <div id="form-section" class="card">
            <h2 class="card-title"><i class="fas fa-road"></i> Cadastrar Nova Viagem</h2>
            <form id="viagemForm">
                <input type="hidden" id="editId" value="">
                <div class="form-row">
                    <div class="form-group">
                        <label for="data"><i class="far fa-calendar-alt"></i> Data</label>
                        <input type="date" id="data">
                        <span id="data-error" class="error"></span>
                    </div>
                    <div class="form-group">
                        <label for="tipo"><i class="fas fa-exchange-alt"></i> Tipo</label>
                        <select id="tipo">
                            <option value="">Selecione...</option>
                            <option value="ida">Ida</option>
                            <option value="volta">Volta</option>
                        </select>
                        <span id="tipo-error" class="error"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="veiculo"><i class="fas fa-truck"></i> Veículo</label>
                        <select id="veiculo">
                            <option value="">Selecione...</option>
                            <option value="VW15.180 - JQR7F07">VW15.180 - JQR7F07</option>
                            <option value="STRADA - SHD8H83">STRADA - SHD8H83</option>
                            <option value="IVECO - NTR8D64">IVECO - NTR8D64</option>
                            <option value="HYUNDAI - SJY8F42">HYUNDAI - SJY8F42</option>
                            <option value="TRUCK - KIS3B61">TRUCK - KIS3B61</option>
                        </select>
                        <span id="veiculo-error" class="error"></span>
                    </div>
                    <div class="form-group">
                        <label for="motorista"><i class="fas fa-user-tie"></i> Motorista</label>
                        <select id="motorista">
                            <option value="">Selecione...</option>
                            <option value="Demerval">Demerval</option>
                            <option value="Caique">Caique</option>
                            <option value="Eudes">Eudes</option>
                            <option value="Marcos">Marcos</option>
                        </select>
                        <span id="motorista-error" class="error"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="colaborador"><i class="fas fa-users"></i> Colaborador</label>
                        <select id="colaborador">
                            <option value="">Selecione...</option>
                            <option value="JEISE">JEISE</option>
                            <option value="MARIANE">MARIANE</option>
                            <option value="MONICA">MONICA</option>
                            <option value="MARIVAL">MARIVAL</option>
                            <option value="Marcia">Marcia</option>
                            <option value="Genivaldo">Genivaldo</option>
                            <option value="Ana">Ana</option>
                        </select>
                        <span id="colaborador-error" class="error"></span>
                    </div>
                    <div class="form-group">
                        <label for="cliente"><i class="fas fa-building"></i> Cliente</label>
                        <input type="text" id="cliente">
                        <span id="cliente-error" class="error"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="origem"><i class="fas fa-map-marker-alt"></i> Origem</label>
                        <input type="text" id="origem">
                        <span id="origem-error" class="error"></span>
                    </div>
                    <div class="form-group">
                        <label for="destino"><i class="fas fa-map-marker"></i> Destino</label>
                        <input type="text" id="destino">
                        <span id="destino-error" class="error"></span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="valor"><i class="fas fa-money-bill-wave"></i> Valor do Frete</label>
                        <input type="text" id="valor" placeholder="Digite o valor">
                        <span id="valor-error" class="error"></span>
                    </div>
                    <div class="form-group">
                        <label for="observacoes"><i class="fas fa-sticky-note"></i> Observações</label>
                        <input type="text" id="observacoes">
                    </div>
                </div>

                <div class="form-row">
                    <button type="button" class="btn btn-primary" id="submitBtn" onclick="adicionarViagem()">
                        <i class="fas fa-save"></i> Salvar Viagem
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="limparFormulario()">
                        <i class="fas fa-broom"></i> Limpar
                    </button>
                    <button type="button" class="btn btn-warning hidden" id="cancelEditBtn" onclick="cancelarEdicao()">
                        <i class="fas fa-times"></i> Cancelar Edição
                    </button>
                </div>
            </form>
        </div>

        <div id="results-section" class="hidden">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-route"></i> Roteiro de Viagens</h2>

                <div class="filter-section">
                    <h3 class="filter-title"><i class="fas fa-filter"></i> Filtros</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filterDataInicio"><i class="far fa-calendar-alt"></i> Data Início</label>
                            <input type="date" id="filterDataInicio">
                        </div>
                        <div class="form-group">
                            <label for="filterDataFim"><i class="far fa-calendar-alt"></i> Data Fim</label>
                            <input type="date" id="filterDataFim">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filterVeiculo"><i class="fas fa-truck"></i> Veículo</label>
                            <select id="filterVeiculo">
                                <option value="">Todos</option>
                                <option value="VW15.180 - JQR7F07">VW15.180 - JQR7F07</option>
                                <option value="STRADA - SHD8H83">STRADA - SHD8H83</option>
                                <option value="IVECO - NTR8D64">IVECO - NTR8D64</option>
                                <option value="HYUNDAI - SJY8F42">HYUNDAI - SJY8F42</option>
                                <option value="TRUCK - KIS3B61">TRUCK - KIS3B61</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filterMotorista"><i class="fas fa-user-tie"></i> Motorista</label>
                            <select id="filterMotorista">
                                <option value="">Todos</option>
                                <option value="Demerval">Demerval</option>
                                <option value="Caique">Caique</option>
                                <option value="Eudes">Eudes</option>
                                <option value="Marcos">Marcos</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">
                            <i class="fas fa-filter"></i> Aplicar Filtros
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="limparFiltros()">
                            <i class="fas fa-broom"></i> Limpar Filtros
                        </button>
                    </div>
                </div>

                <div class="export-buttons">
                    <button type="button" class="btn btn-success" onclick="exportarParaPDF()">
                        <i class="fas fa-file-pdf"></i> Exportar para PDF
                    </button>
                    <button type="button" class="btn btn-info" onclick="exportarParaExcel()">
                        <i class="fas fa-file-excel"></i> Exportar para Excel
                    </button>
                    <button type="button" class="btn btn-danger" onclick="limparTodasViagens()">
                        <i class="fas fa-trash-alt"></i> Limpar Todas as Viagens
                    </button>
                </div>

                <div id="roteiroContainer"></div>
            </div>
        </div>
    </div>
<script>
    // Configuração do Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBQLbjaGe4sjHWpFNnLpIhfeLm_1Xceyoc",
        authDomain: "roteiros-64517.firebaseapp.com",
        databaseURL: "https://roteiros-64517-default-rtdb.firebaseio.com",
        projectId: "roteiros-64517",
        storageBucket: "roteiros-64517.appspot.com",
        messagingSenderId: "154694664377",
        appId: "1:154694664377:web:5be20dd286a29081e5db68"
    };
    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const viagensRef = database.ref('viagens');
    // Armazenamento local para viagens
    let viagens = [];
    let viagensFiltradas = [];
    let editando = false;
    
    // Função para formatar valores no padrão brasileiro
    function formatarValorBrasileiro(valor) {
        // Adiciona uma verificação para garantir que o valor é um número
        if (typeof valor !== 'number' || isNaN(valor)) {
            valor = 0;
        }
        return valor.toLocaleString('pt-BR', {
            style: 'currency',
            currency: 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Função para converter valor brasileiro para número
    function parseValorBrasileiro(valorStr) {
        if (!valorStr) return 0;
        const valorLimpo = valorStr.replace(/\./g, '').replace(',', '.');
        const valorNumerico = parseFloat(valorLimpo);
        return isNaN(valorNumerico) ? 0 : valorNumerico;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const valorInput = document.getElementById('valor');
        valorInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (!value) {
                e.target.value = '';
                return;
            }
            const valorFormatado = (parseFloat(value) / 100).toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
            e.target.value = valorFormatado.replace('R$', '').trim();
        });
    });
    
    function carregarViagens() {
        viagensRef.on('value', (snapshot) => {
            viagens = [];
            const dados = snapshot.val();
            if (dados) {
                Object.keys(dados).forEach(key => {
                    viagens.push({ id: key, ...dados[key] });
                });
                viagens.sort((a, b) => new Date(b.data) - new Date(a.data));
                viagensFiltradas = [...viagens];
            }
            if (document.getElementById('results-section').classList.contains('hidden') === false) {
                gerarRoteiro();
            }
        });
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
        document.getElementById('form-section').classList.toggle('hidden', tabName !== 'form');
        document.getElementById('results-section').classList.toggle('hidden', tabName !== 'results');
        if (tabName === 'results') {
            gerarRoteiro();
        }
    }

    function limparErros() {
        document.querySelectorAll('.error').forEach(el => {
            el.textContent = '';
        });
    }

    function adicionarViagem() {
        limparErros();
        const id = document.getElementById('editId').value;
        const data = document.getElementById('data').value;
        const tipo = document.getElementById('tipo').value;
        const veiculo = document.getElementById('veiculo').value;
        const motorista = document.getElementById('motorista').value;
        const colaborador = document.getElementById('colaborador').value;
        const origem = document.getElementById('origem').value;
        const destino = document.getElementById('destino').value;
        const cliente = document.getElementById('cliente').value;
        const valorInput = document.getElementById('valor').value;
        const valor = parseValorBrasileiro(valorInput);
        const observacoes = document.getElementById('observacoes').value;
        
        /* --- INÍCIO DA ALTERAÇÃO: VALIDAÇÃO REMOVIDA ---
        
        // A validação de campos obrigatórios foi removida (comentada).
        
        let isValid = true;
        if (!data) {
            document.getElementById('data-error').textContent = 'Data é obrigatória';
            isValid = false;
        }
        if (!tipo) {
            document.getElementById('tipo-error').textContent = 'Tipo é obrigatório';
            isValid = false;
        }
        if (!veiculo) {
            document.getElementById('veiculo-error').textContent = 'Veículo é obrigatório';
            isValid = false;
        }
        if (!motorista) {
            document.getElementById('motorista-error').textContent = 'Motorista é obrigatório';
            isValid = false;
        }
        if (!colaborador) {
            document.getElementById('colaborador-error').textContent = 'Colaborador é obrigatório';
            isValid = false;
        }
        if (!origem) {
            document.getElementById('origem-error').textContent = 'Origem é obrigatória';
            isValid = false;
        }
        if (!destino) {
            document.getElementById('destino-error').textContent = 'Destino é obrigatório';
            isValid = false;
        }
        if (!cliente) {
            document.getElementById('cliente-error').textContent = 'Cliente é obrigatório';
            isValid = false;
        }
        if (isNaN(valor) || valorInput === '' || valor <= 0) {
            document.getElementById('valor-error').textContent = 'Valor inválido (deve ser maior que zero)';
            isValid = false;
        }
        if (!isValid) {
            return;
        }
        
        */ // --- FIM DA ALTERAÇÃO ---

        const viagem = {
            data,
            tipo,
            veiculo,
            motorista,
            colaborador,
            origem,
            destino,
            cliente,
            valor,
            observacoes: observacoes || '',
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        if (editando && id) {
            viagensRef.child(id).update(viagem)
                .then(() => {
                    limparFormulario();
                    alert('Viagem atualizada com sucesso!');
                    showTab('results');
                    editando = false;
                })
                .catch(error => {
                    console.error('Erro ao atualizar viagem:', error);
                    alert('Erro ao atualizar viagem: ' + error.message);
                });
        } else {
            viagensRef.push(viagem)
                .then(() => {
                    limparFormulario();
                    alert('Viagem cadastrada com sucesso!');
                    showTab('results');
                })
                .catch(error => {
                    console.error('Erro ao salvar viagem:', error);
                    alert('Erro ao salvar viagem: ' + error.message);
                });
        }
    }

    function editarViagem(id) {
        const viagem = viagens.find(v => v.id === id);
        if (!viagem) return;
        document.getElementById('editId').value = id;
        document.getElementById('data').value = viagem.data;
        document.getElementById('tipo').value = viagem.tipo;
        document.getElementById('veiculo').value = viagem.veiculo;
        document.getElementById('motorista').value = viagem.motorista;
        document.getElementById('colaborador').value = viagem.colaborador;
        document.getElementById('origem').value = viagem.origem;
        document.getElementById('destino').value = viagem.destino;
        document.getElementById('cliente').value = viagem.cliente;
        const valorNumerico = (typeof viagem.valor === 'number') ? viagem.valor : 0;
        const valorFormatado = (valorNumerico).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        document.getElementById('valor').value = valorFormatado;
        document.getElementById('observacoes').value = viagem.observacoes || '';
        editando = true;
        document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i> Atualizar Viagem';
        document.getElementById('cancelEditBtn').classList.remove('hidden');
        showTab('form');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelarEdicao() {
        limparFormulario();
        editando = false;
    }

    function excluirViagem(id) {
        if (confirm('Tem certeza que deseja excluir esta viagem?\nEsta ação não pode ser desfeita!')) {
            viagensRef.child(id).remove()
                .then(() => {
                    alert('Viagem excluída com sucesso!');
                })
                .catch(error => {
                    console.error('Erro ao excluir viagem:', error);
                    alert('Erro ao excluir viagem: ' + error.message);
                });
        }
    }

    function aplicarFiltros() {
        const dataInicio = document.getElementById('filterDataInicio').value;
        const dataFim = document.getElementById('filterDataFim').value;
        const veiculo = document.getElementById('filterVeiculo').value;
        const motorista = document.getElementById('filterMotorista').value;
        viagensFiltradas = viagens.filter(viagem => {
            if (!viagem.data) return true; // Permite que viagens sem data apareçam
            let dataViagem = new Date(viagem.data + 'T00:00:00');
            if (dataInicio && dataViagem < new Date(dataInicio + 'T00:00:00')) {
                return false;
            }
            if (dataFim && dataViagem > new Date(dataFim + 'T00:00:00')) {
                return false;
            }
            if (veiculo && viagem.veiculo !== veiculo) {
                return false;
            }
            if (motorista && viagem.motorista !== motorista) {
                return false;
            }
            return true;
        });
        gerarRoteiro();
    }

    function limparFiltros() {
        document.getElementById('filterDataInicio').value = '';
        document.getElementById('filterDataFim').value = '';
        document.getElementById('filterVeiculo').value = '';
        document.getElementById('filterMotorista').value = '';
        viagensFiltradas = [...viagens];
        gerarRoteiro();
    }

    function limparFormulario() {
        document.getElementById('viagemForm').reset();
        document.getElementById('editId').value = '';
        limparErros();
        if (editando) {
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i> Salvar Viagem';
            document.getElementById('cancelEditBtn').classList.add('hidden');
            editando = false;
        }
    }

    function limparTodasViagens() {
        if (confirm('Tem certeza que deseja apagar TODAS as viagens cadastradas?\nEsta ação não pode ser desfeita!')) {
            viagensRef.remove()
                .then(() => {
                    viagens = [];
                    viagensFiltradas = [];
                    gerarRoteiro();
                    alert('Todas as viagens foram removidas!');
                }).catch(error => {
                    console.error("Erro ao limpar viagens: ", error);
                    alert("Ocorreu um erro ao limpar as viagens.");
                });
        }
    }

    function gerarRoteiro() {
        const roteiroContainer = document.getElementById('roteiroContainer');
        roteiroContainer.innerHTML = '';
        if (viagensFiltradas.length === 0) {
            roteiroContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-box-open"></i>
                    <p>Nenhuma viagem encontrada.</p>
                    <p>Cadastre uma nova viagem ou ajuste seus filtros.</p>
                </div>`;
            return;
        }
        const viagensPorVeiculo = viagensFiltradas.reduce((acc, viagem) => {
            const veiculoKey = viagem.veiculo || 'Veículo não especificado';
            if (!acc[veiculoKey]) {
                acc[veiculoKey] = [];
            }
            acc[veiculoKey].push(viagem);
            return acc;
        }, {});
        for (const veiculo in viagensPorVeiculo) {
            const veiculoCard = document.createElement('div');
            veiculoCard.className = 'veiculo-card';
            let totalFreteVeiculo = 0;
            let tabelaIda = `
                <h3 class="viagem-type">Viagens de Ida</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Data</th><th>Motorista</th><th>Colaborador</th><th>Cliente</th><th>Origem</th><th>Destino</th><th>Valor</th><th>Obs.</th><th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>`;
            let tabelaVolta = `
                <h3 class="viagem-type">Viagens de Volta</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Data</th><th>Motorista</th><th>Colaborador</th><th>Cliente</th><th>Origem</th><th>Destino</th><th>Valor</th><th>Obs.</th><th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>`;
            let temIda = false;
            let temVolta = false;
            viagensPorVeiculo[veiculo].forEach(viagem => {
                totalFreteVeiculo += viagem.valor || 0;
                const dataViagem = viagem.data ? new Date(viagem.data + 'T00:00:00') : null;
                const dataFormatada = dataViagem ? dataViagem.toLocaleDateString('pt-BR') : 'N/A';
                const linha = `
                    <tr>
                        <td>${dataFormatada}</td>
                        <td>${viagem.motorista || '-'}</td>
                        <td>${viagem.colaborador || '-'}</td>
                        <td>${viagem.cliente || '-'}</td>
                        <td>${viagem.origem || '-'}</td>
                        <td>${viagem.destino || '-'}</td>
                        <td>${formatarValorBrasileiro(viagem.valor)}</td>
                        <td>${viagem.observacoes || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-warning action-btn" onclick="editarViagem('${viagem.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger action-btn" onclick="excluirViagem('${viagem.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
                if (viagem.tipo === 'ida') {
                    tabelaIda += linha;
                    temIda = true;
                } else {
                    tabelaVolta += linha;
                    temVolta = true;
                }
            });
            tabelaIda += `</tbody></table>`;
            tabelaVolta += `</tbody></table>`;
            veiculoCard.innerHTML = `
                <h2 class="veiculo-title"><i class="fas fa-truck"></i> ${veiculo}</h2>
                ${temIda ? tabelaIda : ''}
                ${temVolta ? tabelaVolta : ''}
                <div class="total">Total do Veículo: ${formatarValorBrasileiro(totalFreteVeiculo)}</div>`;
            roteiroContainer.appendChild(veiculoCard);
        }
        const totalGeral = viagensFiltradas.reduce((acc, v) => acc + (v.valor || 0), 0);
        roteiroContainer.innerHTML += `<div class="total" style="font-size: 1.5rem; text-align: center; margin-top: 2rem;">Total Geral: ${formatarValorBrasileiro(totalGeral)}</div>`;
    }

    <script>
function exportarParaPDF() {
    const { jsPDF } = window.jspdf;
    const roteiroContainer = document.getElementById("roteiroContainer");
    
    // Clonamos o container para modificar sem afetar o layout original
    const containerClone = roteiroContainer.cloneNode(true);
    
    // Ajustes no clone para melhor visualização no PDF
    containerClone.style.width = "100%";
    containerClone.style.padding = "20px";
    containerClone.style.boxSizing = "border-box";
    
    // Remove botões de ação que não fazem sentido no PDF
    const actionButtons = containerClone.querySelectorAll('.action-buttons');
    actionButtons.forEach(btn => btn.remove());
    
    // Adiciona o clone temporariamente ao corpo
    const tempDiv = document.createElement('div');
    tempDiv.appendChild(containerClone);
    tempDiv.style.position = "absolute";
    tempDiv.style.left = "-9999px";
    document.body.appendChild(tempDiv);
    
    // Configurações para html2canvas
    const options = {
        scale: 2, // Melhor qualidade
        useCORS: true,
        allowTaint: true,
        scrollY: 0,
        width: containerClone.scrollWidth,
        height: containerClone.scrollHeight,
        windowWidth: containerClone.scrollWidth,
        windowHeight: containerClone.scrollHeight
    };
    
    html2canvas(containerClone, options).then(canvas => {
        // Remove o clone temporário
        document.body.removeChild(tempDiv);
        
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jsPDF("l", "mm", "a4"); // Modo paisagem
        
        // Adiciona título e data
        pdf.setFontSize(18);
        pdf.setTextColor(40);
        pdf.text("Relatório Completo de Viagens", 148, 15, { align: 'center' });
        
        pdf.setFontSize(12);
        pdf.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 148, 22, { align: 'center' });
        
        // Calcula dimensões para o modo paisagem
        const pageWidth = pdf.internal.pageSize.getWidth() - 20;
        const pageHeight = pdf.internal.pageSize.getHeight() - 30;
        
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pageWidth;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        let position = 25; // Posição inicial após o cabeçalho
        let currentPage = 1;
        let heightLeft = pdfHeight;
        
        // Adiciona a imagem em páginas conforme necessário
        while (heightLeft > 0) {
            pdf.addImage(imgData, "PNG", 10, position, pdfWidth, pdfHeight);
            heightLeft -= pageHeight;
            
            // Adiciona número da página
            pdf.setFontSize(10);
            pdf.text(`Página ${currentPage}`, 148, pageHeight + 20, { align: 'center' });
            
            if (heightLeft > 0) {
                pdf.addPage("l"); // Nova página no modo paisagem
                currentPage++;
                position = 10; // Reset position for new page
                heightLeft -= 15; // Ajuste para evitar sobreposição
            }
        }
        
        pdf.save("relatorio_viagens_completo.pdf");
        
    }).catch(error => {
        console.error("Erro ao gerar PDF:", error);
        document.body.removeChild(tempDiv);
        alert("Ocorreu um erro ao gerar o PDF. Por favor, tente novamente.");
    });
}
</script>

    function exportarParaExcel() {
        const dadosExport = viagensFiltradas.map(v => ({
            Data: v.data ? new Date(v.data + 'T00:00:00').toLocaleDateString('pt-BR') : '',
            Tipo: v.tipo || '',
            Veículo: v.veiculo || '',
            Motorista: v.motorista || '',
            Colaborador: v.colaborador || '',
            Cliente: v.cliente || '',
            Origem: v.origem || '',
            Destino: v.destino || '',
            Valor: v.valor || 0,
            Observações: v.observacoes || ''
        }));
        const ws = XLSX.utils.json_to_sheet(dadosExport);
        ws['!cols'] = [{ wch: 10 }, { wch: 8 }, { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 12 }, { wch: 30 }];
        for(let i = 2; i <= dadosExport.length + 1; i++) {
            const cellRef = 'I' + i;
            if(ws[cellRef]) {
                ws[cellRef].t = 'n';
                ws[cellRef].z = 'R$ #,##0.00';
            }
        }
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Viagens");
        XLSX.writeFile(wb, "roteiro_viagens.xlsx");
    }
    
    // Carregar viagens ao iniciar
    carregarViagens();
</script>
</body>
</html>
