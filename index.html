<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roteirizador de Viagens</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --dark: #1b263b;
            --light: #f8f9fa;
            --success: #4cc9f0;
            --warning: #f72585;
            --gray: #adb5bd;
            --white: #ffffff;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 1rem;
        }
        
        .logo i {
            font-size: 2rem;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }
        
        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 500;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .card-title {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            font-size: 1.2rem;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }
        
        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray);
            border-radius: 6px;
            font-family: 'Poppins', sans-serif;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d91a6a;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: var(--gray);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #8d99ae;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3aa8d0;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #138496;
            transform: translateY(-2px);
        }
        
        .error {
            color: var(--warning);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: block;
        }
        
        .veiculo-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary);
        }
        
        .veiculo-title {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .viagem-type {
            font-size: 1rem;
            margin: 1.5rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--gray);
            color: var(--primary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }
        
        th {
            background-color: var(--primary);
            color: white;
            padding: 0.75rem;
            text-align: left;
        }
        
        td {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e9ecef;
        }
        
        .total {
            font-weight: 600;
            text-align: right;
            font-size: 1.1rem;
            margin-top: 1rem;
            color: var(--dark);
        }
        
        .hidden {
            display: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--gray);
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            padding: 0.35rem 0.5rem;
            font-size: 0.8rem;
            border-radius: 4px;
        }
        
        .edit-form {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #eee;
        }
        
        .filter-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .filter-title {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .form-group {
                margin-bottom: 1rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
            }
            
            .export-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-truck-moving"></i>
                <h1>Roteirizador de Viagens</h1>
            </div>
            <p>Controle completo das viagens da sua frota</p>
        </header>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('form')">
                <i class="fas fa-plus-circle"></i> Nova Viagem
            </div>
            <div class="tab" onclick="showTab('results')">
                <i class="fas fa-list-ul"></i> Visualizar Roteiros
            </div>
        </div>
        
        <div id="form-section" class="card">
            <h2 class="card-title"><i class="fas fa-road"></i> Cadastrar Nova Viagem</h2>
            <form id="viagemForm">
                <input type="hidden" id="editId" value="">
                <div class="form-row">
                    <div class="form-group">
                        <label for="data"><i class="far fa-calendar-alt"></i> Data</label>
                        <input type="date" id="data" required>
                        <span id="data-error" class="error"></span>
                    </div>
                    <div class="form-group">
                        <label for="tipo"><i class="fas fa-exchange-alt"></i> Tipo</label>
                        <select id="tipo" required>
                            <option value="">Selecione...</option>
                            <option value="ida">Ida</option>
                            <option value="volta">Volta</option>
                        </select>
                        <span id="tipo-error" class="error"></span>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="veiculo"><i class="fas fa-truck"></i> Veículo</label>
                        <select id="veiculo" required>
                            <option value="">Selecione...</option>
                            <option value="VW15.180 - JQR7F07">VW15.180 - JQR7F07</option>
                            <option value="STRADA - SHD8H83">STRADA - SHD8H83</option>
                            <option value="IVECO - NTR8D64">IVECO - NTR8D64</option>
                            <option value="HYUNDAI - SJY8F42">HYUNDAI - SJY8F42</option>
                            <option value="TRUCK - KIS3B61">TRUCK - KIS3B61</option>
                        </select>
                        <span id="veiculo-error" class="error"></span>
                    </div>
                    <div class="form-group">
                        <label for="motorista"><i class="fas fa-user-tie"></i> Motorista</label>
                        <select id="motorista" required>
                            <option value="">Selecione...</option>
                            <option value="Demerval">Demerval</option>
                            <option value="Caique">Caique</option>
                            <option value="Eudes">Eudes</option>
                            <option value="Marcos">Marcos</option>
                        </select>
                        <span id="motorista-error" class="error"></span>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="colaborador"><i class="fas fa-users"></i> Colaborador</label>
                        <select id="colaborador" required>
                            <option value="">Selecione...</option>
                            <option value="JEISE">JEISE</option>
                            <option value="MARIANE">MARIANE</option>
                            <option value="MONICA">MONICA</option>
                            <option value="MARIVAL">MARIVAL</option>
                            <option value="Marcia">Marcia</option>
                            <option value="Genivaldo">Genivaldo</option>
                            <option value="Ana">Ana</option>
                        </select>
                        <span id="colaborador-error" class="error"></span>
                    </div>
                    <div class="form-group">
                        <label for="cliente"><i class="fas fa-building"></i> Cliente</label>
                        <input type="text" id="cliente" required>
                        <span id="cliente-error" class="error"></span>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="origem"><i class="fas fa-map-marker-alt"></i> Origem</label>
                        <input type="text" id="origem" required>
                        <span id="origem-error" class="error"></span>
                    </div>
                    <div class="form-group">
                        <label for="destino"><i class="fas fa-map-marker"></i> Destino</label>
                        <input type="text" id="destino" required>
                        <span id="destino-error" class="error"></span>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="valor"><i class="fas fa-money-bill-wave"></i> Valor do Frete (R$)</label>
                        <input type="number" id="valor" step="0.01" min="0" required>
                        <span id="valor-error" class="error"></span>
                    </div>
                    <div class="form-group">
                        <label for="observacoes"><i class="fas fa-sticky-note"></i> Observações</label>
                        <input type="text" id="observacoes">
                    </div>
                </div>
                
                <div class="form-row">
                    <button type="button" class="btn btn-primary" id="submitBtn" onclick="adicionarViagem()">
                        <i class="fas fa-save"></i> Salvar Viagem
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="limparFormulario()">
                        <i class="fas fa-broom"></i> Limpar
                    </button>
                    <button type="button" class="btn btn-warning hidden" id="cancelEditBtn" onclick="cancelarEdicao()">
                        <i class="fas fa-times"></i> Cancelar Edição
                    </button>
                </div>
            </form>
        </div>
        
        <div id="results-section" class="hidden">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-route"></i> Roteiro de Viagens</h2>
                
                <div class="filter-section">
                    <h3 class="filter-title"><i class="fas fa-filter"></i> Filtros</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filterDataInicio"><i class="far fa-calendar-alt"></i> Data Início</label>
                            <input type="date" id="filterDataInicio">
                        </div>
                        <div class="form-group">
                            <label for="filterDataFim"><i class="far fa-calendar-alt"></i> Data Fim</label>
                            <input type="date" id="filterDataFim">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filterVeiculo"><i class="fas fa-truck"></i> Veículo</label>
                            <select id="filterVeiculo">
                                <option value="">Todos</option>
                                <option value="VW15.180 - JQR7F07">VW15.180 - JQR7F07</option>
                                <option value="STRADA - SHD8H83">STRADA - SHD8H83</option>
                                <option value="IVECO - NTR8D64">IVECO - NTR8D64</option>
                                <option value="HYUNDAI - SJY8F42">HYUNDAI - SJY8F42</option>
                                <option value="TRUCK - KIS3B61">TRUCK - KIS3B61</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filterMotorista"><i class="fas fa-user-tie"></i> Motorista</label>
                            <select id="filterMotorista">
                                <option value="">Todos</option>
                                <option value="Demerval">Demerval</option>
                                <option value="Caique">Caique</option>
                                <option value="Eudes">Eudes</option>
                                <option value="Marcos">Marcos</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">
                            <i class="fas fa-filter"></i> Aplicar Filtros
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="limparFiltros()">
                            <i class="fas fa-broom"></i> Limpar Filtros
                        </button>
                    </div>
                </div>
                
                <div class="export-buttons">
                    <button type="button" class="btn btn-success" onclick="exportarParaPDF()">
                        <i class="fas fa-file-pdf"></i> Exportar para PDF
                    </button>
                    <button type="button" class="btn btn-info" onclick="exportarParaExcel()">
                        <i class="fas fa-file-excel"></i> Exportar para Excel
                    </button>
                    <button type="button" class="btn btn-danger" onclick="limparTodasViagens()">
                        <i class="fas fa-trash-alt"></i> Limpar Todas as Viagens
                    </button>
                </div>
                
                <div id="roteiroContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Firebase com suas credenciais
        const firebaseConfig = {
            apiKey: "AIzaSyBQLbjaGe4sjHWpFNnLpIhfeLm_1Xceyoc",
            authDomain: "roteiros-64517.firebaseapp.com",
            databaseURL: "https://roteiros-64517-default-rtdb.firebaseio.com",
            projectId: "roteiros-64517",
            storageBucket: "roteiros-64517.appspot.com",
            messagingSenderId: "154694664377",
            appId: "1:154694664377:web:5be20dd286a29081e5db68"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Referência para o banco de dados
        const viagensRef = database.ref('viagens');

        // Armazenamento local para viagens
        let viagens = [];
        let viagensFiltradas = [];
        let editando = false;

        // Carregar viagens do Firebase
        function carregarViagens() {
            viagensRef.on('value', (snapshot) => {
                viagens = [];
                const dados = snapshot.val();
                if (dados) {
                    Object.keys(dados).forEach(key => {
                        viagens.push({ id: key, ...dados[key] });
                    });
                    // Ordenar por data (mais recente primeiro)
                    viagens.sort((a, b) => new Date(b.data) - new Date(a.data));
                    viagensFiltradas = [...viagens];
                }
                if (document.getElementById('results-section').classList.contains('hidden') === false) {
                    gerarRoteiro();
                }
            });
        }

        // Mostrar tab selecionada
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            document.getElementById('form-section').classList.toggle('hidden', tabName !== 'form');
            document.getElementById('results-section').classList.toggle('hidden', tabName !== 'results');
            
            if (tabName === 'results') {
                gerarRoteiro();
            }
        }

        // Limpar mensagens de erro
        function limparErros() {
            document.querySelectorAll('.error').forEach(el => {
                el.textContent = '';
            });
        }

        // Adicionar nova viagem ou atualizar existente
        function adicionarViagem() {
            limparErros();
            
            const id = document.getElementById('editId').value;
            const data = document.getElementById('data').value;
            const tipo = document.getElementById('tipo').value;
            const veiculo = document.getElementById('veiculo').value;
            const motorista = document.getElementById('motorista').value;
            const colaborador = document.getElementById('colaborador').value;
            const origem = document.getElementById('origem').value;
            const destino = document.getElementById('destino').value;
            const cliente = document.getElementById('cliente').value;
            const valorInput = document.getElementById('valor').value;
            const valor = parseFloat(valorInput);
            const observacoes = document.getElementById('observacoes').value;
            
            // Validação dos campos
            let isValid = true;
            
            if (!data) {
                document.getElementById('data-error').textContent = 'Data é obrigatória';
                isValid = false;
            }
            
            if (!tipo) {
                document.getElementById('tipo-error').textContent = 'Tipo é obrigatório';
                isValid = false;
            }
            
            if (!veiculo) {
                document.getElementById('veiculo-error').textContent = 'Veículo é obrigatório';
                isValid = false;
            }
            
            if (!motorista) {
                document.getElementById('motorista-error').textContent = 'Motorista é obrigatório';
                isValid = false;
            }
            
            if (!colaborador) {
                document.getElementById('colaborador-error').textContent = 'Colaborador é obrigatório';
                isValid = false;
            }
            
            if (!origem) {
                document.getElementById('origem-error').textContent = 'Origem é obrigatória';
                isValid = false;
            }
            
            if (!destino) {
                document.getElementById('destino-error').textContent = 'Destino é obrigatório';
                isValid = false;
            }
            
            if (!cliente) {
                document.getElementById('cliente-error').textContent = 'Cliente é obrigatório';
                isValid = false;
            }
            
            if (isNaN(valor) || valorInput === '' || valor <= 0) {
                document.getElementById('valor-error').textContent = 'Valor inválido (deve ser maior que zero)';
                isValid = false;
            }
            
            if (!isValid) {
                return;
            }
            
            const viagem = {
                data,
                tipo,
                veiculo,
                motorista,
                colaborador,
                origem,
                destino,
                cliente,
                valor,
                observacoes: observacoes || '',
                timestamp: editando ? firebase.database.ServerValue.TIMESTAMP : firebase.database.ServerValue.TIMESTAMP
            };
            
            if (editando && id) {
                // Atualizar viagem existente
                viagensRef.child(id).update(viagem)
                    .then(() => {
                        limparFormulario();
                        alert('Viagem atualizada com sucesso!');
                        showTab('results');
                        editando = false;
                    })
                    .catch(error => {
                        console.error('Erro ao atualizar viagem:', error);
                        alert('Erro ao atualizar viagem: ' + error.message);
                    });
            } else {
                // Salvar nova viagem
                viagensRef.push(viagem)
                    .then(() => {
                        limparFormulario();
                        alert('Viagem cadastrada com sucesso!');
                        showTab('results');
                    })
                    .catch(error => {
                        console.error('Erro ao salvar viagem:', error);
                        alert('Erro ao salvar viagem: ' + error.message);
                    });
            }
        }

        // Editar viagem
        function editarViagem(id) {
            const viagem = viagens.find(v => v.id === id);
            if (!viagem) return;
            
            document.getElementById('editId').value = id;
            document.getElementById('data').value = viagem.data;
            document.getElementById('tipo').value = viagem.tipo;
            document.getElementById('veiculo').value = viagem.veiculo;
            document.getElementById('motorista').value = viagem.motorista;
            document.getElementById('colaborador').value = viagem.colaborador;
            document.getElementById('origem').value = viagem.origem;
            document.getElementById('destino').value = viagem.destino;
            document.getElementById('cliente').value = viagem.cliente;
            document.getElementById('valor').value = viagem.valor;
            document.getElementById('observacoes').value = viagem.observacoes || '';
            
            // Atualizar UI para modo edição
            editando = true;
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i> Atualizar Viagem';
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            
            // Mostrar tab de formulário
            showTab('form');
            
            // Rolar para o topo do formulário
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Cancelar edição
        function cancelarEdicao() {
            limparFormulario();
            editando = false;
        }

        // Excluir viagem
        function excluirViagem(id) {
            if (confirm('Tem certeza que deseja excluir esta viagem?\nEsta ação não pode ser desfeita!')) {
                viagensRef.child(id).remove()
                    .then(() => {
                        alert('Viagem excluída com sucesso!');
                    })
                    .catch(error => {
                        console.error('Erro ao excluir viagem:', error);
                        alert('Erro ao excluir viagem: ' + error.message);
                    });
            }
        }

        // Aplicar filtros
        function aplicarFiltros() {
            const dataInicio = document.getElementById('filterDataInicio').value;
            const dataFim = document.getElementById('filterDataFim').value;
            const veiculo = document.getElementById('filterVeiculo').value;
            const motorista = document.getElementById('filterMotorista').value;
            
            viagensFiltradas = viagens.filter(viagem => {
                // Filtro por data
                if (dataInicio && new Date(viagem.data) < new Date(dataInicio)) {
                    return false;
                }
                if (dataFim && new Date(viagem.data) > new Date(dataFim)) {
                    return false;
                }
                
                // Filtro por veículo
                if (veiculo && viagem.veiculo !== veiculo) {
                    return false;
                }
                
                // Filtro por motorista
                if (motorista && viagem.motorista !== motorista) {
                    return false;
                }
                
                return true;
            });
            
            gerarRoteiro();
        }

        // Limpar filtros
        function limparFiltros() {
            document.getElementById('filterDataInicio').value = '';
            document.getElementById('filterDataFim').value = '';
            document.getElementById('filterVeiculo').value = '';
            document.getElementById('filterMotorista').value = '';
            
            viagensFiltradas = [...viagens];
            gerarRoteiro();
        }

        // Limpar formulário
        function limparFormulario() {
            document.getElementById('viagemForm').reset();
            document.getElementById('editId').value = '';
            limparErros();
            
            if (editando) {
                document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i> Salvar Viagem';
                document.getElementById('cancelEditBtn').classList.add('hidden');
                editando = false;
            }
        }

        // Limpar todas as viagens
        function limparTodasViagens() {
            if (confirm('Tem certeza que deseja apagar TODAS as viagens cadastradas?\nEsta ação não pode ser desfeita!')) {
                viagensRef.remove()
                    .then(() => {
                        viagens = [];
                        viagensFiltradas = [];
                        gerarRoteiro();
                        alert('Todas as viagens foram removidas!');
                    })
                    .catch(error => {
                        console.error('Erro ao remover viagens:', error);
                        alert('Erro ao remover viagens: ' + error.message);
                    });
            }
        }

        // Exportar para PDF
       function exportarParaPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
    });
    
    // Configurações iniciais
    const marginLeft = 10;
    const marginRight = 10;
    const pageWidth = doc.internal.pageSize.getWidth() - marginLeft - marginRight;
    let y = 20;
    
    // Estilos
    const styles = {
        title: { fontSize: 16, fontStyle: 'bold', textColor: [40, 53, 147] },
        subtitle: { fontSize: 12, fontStyle: 'bold', textColor: [67, 97, 238] },
        header: { fontSize: 10, fontStyle: 'bold', textColor: [255, 255, 255], fillColor: [67, 97, 238] },
        body: { fontSize: 9, textColor: [0, 0, 0] },
        total: { fontSize: 11, fontStyle: 'bold', textColor: [0, 0, 0] }
    };
    
    // Função para adicionar nova página se necessário
    const checkPageBreak = (requiredSpace) => {
        if (y + requiredSpace > doc.internal.pageSize.getHeight() - 20) {
            doc.addPage();
            y = 20;
            return true;
        }
        return false;
    };
    
    // Título do documento
    doc.setFontSize(styles.title.fontSize);
    doc.setTextColor(...styles.title.textColor);
    doc.setFont(undefined, styles.title.fontStyle);
    doc.text('Relatório de Viagens', doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
    y += 10;
    
    // Data de emissão
    const hoje = new Date().toLocaleDateString('pt-BR');
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.setFont(undefined, 'normal');
    doc.text(`Emitido em: ${hoje}`, doc.internal.pageSize.getWidth() / 2, y, { align: 'center' });
    y += 15;
    
    // Agrupar viagens por veículo
    const veiculos = {};
    viagensFiltradas.forEach(viagem => {
        if (!veiculos[viagem.veiculo]) {
            veiculos[viagem.veiculo] = { ida: [], volta: [] };
        }
        veiculos[viagem.veiculo][viagem.tipo].push(viagem);
    });
    
    // Larguras das colunas (em mm)
    const columnWidths = {
        data: 20,
        motorista: 25,
        colaborador: 25,
        cliente: 25,
        rota: 40,
        valor: 20,
        obs: 25
    };
    
    // Posições das colunas (calculadas dinamicamente)
    const colPositions = {
        data: marginLeft + 2,
        motorista: marginLeft + columnWidths.data + 5,
        colaborador: marginLeft + columnWidths.data + columnWidths.motorista + 5,
        cliente: marginLeft + columnWidths.data + columnWidths.motorista + columnWidths.colaborador + 5,
        rota: marginLeft + columnWidths.data + columnWidths.motorista + columnWidths.colaborador + columnWidths.cliente + 5,
        valor: marginLeft + columnWidths.data + columnWidths.motorista + columnWidths.colaborador + columnWidths.cliente + columnWidths.rota + 5,
        obs: marginLeft + columnWidths.data + columnWidths.motorista + columnWidths.colaborador + columnWidths.cliente + columnWidths.rota + columnWidths.valor + 5
    };
    
    // Verificar se as colunas cabem na página
    const totalWidth = Object.values(columnWidths).reduce((a, b) => a + b, 0) + (Object.keys(columnWidths).length * 5);
    if (totalWidth > pageWidth) {
        alert('Aviso: Algumas colunas podem estar muito estreitas no PDF devido à quantidade de informações. Considere filtrar os dados ou exportar para Excel para mais detalhes.');
    }
    
    // Adicionar conteúdo para cada veículo
    for (const veiculo in veiculos) {
        // Verificar espaço antes de adicionar novo veículo
        checkPageBreak(30);
        
        // Título do veículo
        doc.setFontSize(styles.subtitle.fontSize);
        doc.setTextColor(...styles.subtitle.textColor);
        doc.setFont(undefined, styles.subtitle.fontStyle);
        doc.text(`Veículo: ${veiculo}`, marginLeft, y);
        y += 8;
        
        // Seção de IDA
        if (veiculos[veiculo].ida.length > 0) {
            doc.setFontSize(styles.subtitle.fontSize - 1);
            doc.setTextColor(...styles.subtitle.textColor);
            doc.text('Viagens de Ida:', marginLeft, y);
            y += 6;
            
            // Cabeçalho da tabela
            doc.setFontSize(styles.header.fontSize);
            doc.setTextColor(...styles.header.textColor);
            doc.setFillColor(...styles.header.fillColor);
            doc.rect(marginLeft, y, pageWidth, 6, 'F');
            
            // Texto do cabeçalho
            doc.text('Data', colPositions.data, y + 4);
            doc.text('Motorista', colPositions.motorista, y + 4);
            doc.text('Colaborador', colPositions.colaborador, y + 4);
            doc.text('Cliente', colPositions.cliente, y + 4);
            doc.text('Origem → Destino', colPositions.rota, y + 4);
            doc.text('Valor (R$)', colPositions.valor, y + 4);
            doc.text('Obs', colPositions.obs, y + 4);
            y += 6;
            
            // Conteúdo da tabela
            doc.setFontSize(styles.body.fontSize);
            doc.setTextColor(...styles.body.textColor);
            doc.setFont(undefined, 'normal');
            
            veiculos[veiculo].ida.forEach(viagem => {
                checkPageBreak(6); // Verificar se precisa de nova página
                
                // Formatar texto longo para caber na célula
                const motorista = doc.splitTextToSize(viagem.motorista, columnWidths.motorista - 2);
                const colaborador = doc.splitTextToSize(viagem.colaborador, columnWidths.colaborador - 2);
                const cliente = doc.splitTextToSize(viagem.cliente, columnWidths.cliente - 2);
                const rota = doc.splitTextToSize(`${viagem.origem} → ${viagem.destino}`, columnWidths.rota - 2);
                const obs = viagem.observacoes ? doc.splitTextToSize(viagem.observacoes, columnWidths.obs - 2) : [''];
                
                // Altura da linha baseada no maior conjunto de linhas divididas
                const lineCount = Math.max(
                    motorista.length, 
                    colaborador.length, 
                    cliente.length, 
                    rota.length,
                    obs.length
                );
                
                // Desenhar conteúdo
                doc.text(formatarData(viagem.data), colPositions.data, y + 4);
                
                // Motorista (multilinha se necessário)
                motorista.forEach((line, i) => {
                    doc.text(line, colPositions.motorista, y + 4 + (i * 3.5));
                });
                
                // Colaborador (multilinha se necessário)
                colaborador.forEach((line, i) => {
                    doc.text(line, colPositions.colaborador, y + 4 + (i * 3.5));
                });
                
                // Cliente (multilinha se necessário)
                cliente.forEach((line, i) => {
                    doc.text(line, colPositions.cliente, y + 4 + (i * 3.5));
                });
                
                // Rota (multilinha se necessário)
                rota.forEach((line, i) => {
                    doc.text(line, colPositions.rota, y + 4 + (i * 3.5));
                });
                
                // Valor (alinhado à direita)
                doc.text(viagem.valor.toFixed(2).replace('.', ','), colPositions.valor, y + 4, { align: 'right' });
                
                // Observações (multilinha se necessário)
                obs.forEach((line, i) => {
                    doc.text(line, colPositions.obs, y + 4 + (i * 3.5));
                });
                
                // Ajustar altura da linha baseada no conteúdo
                y += 5 + ((lineCount - 1) * 3.5);
            });
            
            // Subtotal
            const subtotalIda = veiculos[veiculo].ida.reduce((sum, viagem) => sum + viagem.valor, 0);
            doc.setFontSize(styles.total.fontSize);
            doc.setFont(undefined, styles.total.fontStyle);
            doc.text(`Subtotal Ida: R$ ${subtotalIda.toFixed(2).replace('.', ',')}`, 
                     marginLeft + pageWidth - 20, y + 4, { align: 'right' });
            y += 10;
        }
        
        // Seção de VOLTA
        if (veiculos[veiculo].volta.length > 0) {
            checkPageBreak(20);
            
            doc.setFontSize(styles.subtitle.fontSize - 1);
            doc.setTextColor(...styles.subtitle.textColor);
            doc.text('Viagens de Volta:', marginLeft, y);
            y += 6;
            
            // Cabeçalho da tabela (mesmo layout da ida)
            doc.setFontSize(styles.header.fontSize);
            doc.setTextColor(...styles.header.textColor);
            doc.setFillColor(...styles.header.fillColor);
            doc.rect(marginLeft, y, pageWidth, 6, 'F');
            
            // Texto do cabeçalho
            doc.text('Data', colPositions.data, y + 4);
            doc.text('Motorista', colPositions.motorista, y + 4);
            doc.text('Colaborador', colPositions.colaborador, y + 4);
            doc.text('Cliente', colPositions.cliente, y + 4);
            doc.text('Origem → Destino', colPositions.rota, y + 4);
            doc.text('Valor (R$)', colPositions.valor, y + 4);
            doc.text('Obs', colPositions.obs, y + 4);
            y += 6;
            
            // Conteúdo da tabela
            doc.setFontSize(styles.body.fontSize);
            doc.setTextColor(...styles.body.textColor);
            doc.setFont(undefined, 'normal');
            
            veiculos[veiculo].volta.forEach(viagem => {
                checkPageBreak(6); // Verificar se precisa de nova página
                
                // Formatar texto longo para caber na célula
                const motorista = doc.splitTextToSize(viagem.motorista, columnWidths.motorista - 2);
                const colaborador = doc.splitTextToSize(viagem.colaborador, columnWidths.colaborador - 2);
                const cliente = doc.splitTextToSize(viagem.cliente, columnWidths.cliente - 2);
                const rota = doc.splitTextToSize(`${viagem.origem} → ${viagem.destino}`, columnWidths.rota - 2);
                const obs = viagem.observacoes ? doc.splitTextToSize(viagem.observacoes, columnWidths.obs - 2) : [''];
                
                // Altura da linha baseada no maior conjunto de linhas divididas
                const lineCount = Math.max(
                    motorista.length, 
                    colaborador.length, 
                    cliente.length, 
                    rota.length,
                    obs.length
                );
                
                // Desenhar conteúdo
                doc.text(formatarData(viagem.data), colPositions.data, y + 4);
                
                // Motorista (multilinha se necessário)
                motorista.forEach((line, i) => {
                    doc.text(line, colPositions.motorista, y + 4 + (i * 3.5));
                });
                
                // Colaborador (multilinha se necessário)
                colaborador.forEach((line, i) => {
                    doc.text(line, colPositions.colaborador, y + 4 + (i * 3.5));
                });
                
                // Cliente (multilinha se necessário)
                cliente.forEach((line, i) => {
                    doc.text(line, colPositions.cliente, y + 4 + (i * 3.5));
                });
                
                // Rota (multilinha se necessário)
                rota.forEach((line, i) => {
                    doc.text(line, colPositions.rota, y + 4 + (i * 3.5));
                });
                
                // Valor (alinhado à direita)
                doc.text(viagem.valor.toFixed(2).replace('.', ','), colPositions.valor, y + 4, { align: 'right' });
                
                // Observações (multilinha se necessário)
                obs.forEach((line, i) => {
                    doc.text(line, colPositions.obs, y + 4 + (i * 3.5));
                });
                
                // Ajustar altura da linha baseada no conteúdo
                y += 5 + ((lineCount - 1) * 3.5);
            });
            
            // Subtotal
            const subtotalVolta = veiculos[veiculo].volta.reduce((sum, viagem) => sum + viagem.valor, 0);
            doc.setFontSize(styles.total.fontSize);
            doc.setFont(undefined, styles.total.fontStyle);
            doc.text(`Subtotal Volta: R$ ${subtotalVolta.toFixed(2).replace('.', ',')}`, 
                     marginLeft + pageWidth - 20, y + 4, { align: 'right' });
            y += 15;
        }
    }
    
    // Calcular total geral
    const totalGeral = viagensFiltradas.reduce((sum, viagem) => sum + viagem.valor, 0);
    
    // Adicionar total geral em nova página se necessário
    checkPageBreak(10);
    
    // Linha divisória
    doc.setDrawColor(200, 200, 200);
    doc.line(marginLeft, y, marginLeft + pageWidth, y);
    y += 5;
    
    // Total geral
    doc.setFontSize(styles.total.fontSize + 2);
    doc.setFont(undefined, 'bold');
    doc.text(`Total Geral: R$ ${totalGeral.toFixed(2).replace('.', ',')}`, 
             marginLeft + pageWidth - 20, y + 5, { align: 'right' });
    
    // Salvar o PDF
    doc.save(`Relatorio_Viagens_${new Date().toISOString().slice(0, 10)}.pdf`);
}

        // Exportar para Excel
        function exportarParaExcel() {
            // Preparar os dados
            const dados = [];
            
            // Adicionar cabeçalho
            dados.push([
                'Data', 'Tipo', 'Veículo', 'Motorista', 'Colaborador', 
                'Origem', 'Destino', 'Cliente', 'Valor (R$)', 'Observações'
            ]);
            
            // Adicionar as viagens
            viagensFiltradas.forEach(viagem => {
                dados.push([
                    formatarData(viagem.data),
                    viagem.tipo === 'ida' ? 'Ida' : 'Volta',
                    viagem.veiculo,
                    viagem.motorista,
                    viagem.colaborador,
                    viagem.origem,
                    viagem.destino,
                    viagem.cliente,
                    viagem.valor,
                    viagem.observacoes || ''
                ]);
            });
            
            // Calcular total geral
            const totalGeral = viagensFiltradas.reduce((sum, viagem) => sum + viagem.valor, 0);
            
            // Adicionar linha de total
            dados.push([
                '', '', '', '', '', '', '', 'Total Geral:', totalGeral, ''
            ]);
            
            // Criar planilha
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dados);
            
            // Adicionar planilha ao workbook
            XLSX.utils.book_append_sheet(wb, ws, "Viagens");
            
            // Gerar arquivo Excel
            XLSX.writeFile(wb, `Relatorio_Viagens_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        // Formatar data para exibição
        function formatarData(dataStr) {
            const [ano, mes, dia] = dataStr.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        // Gerar o roteiro completo
        function gerarRoteiro() {
            const container = document.getElementById('roteiroContainer');
            container.innerHTML = '';
            
            if (viagensFiltradas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-road"></i>
                        <h3>Nenhuma viagem encontrada</h3>
                        <p>Nenhuma viagem corresponde aos filtros aplicados</p>
                    </div>
                `;
                return;
            }
            
            // Agrupar viagens por veículo
            const veiculos = {};
            viagensFiltradas.forEach(viagem => {
                if (!veiculos[viagem.veiculo]) {
                    veiculos[viagem.veiculo] = { ida: [], volta: [] };
                }
                veiculos[viagem.veiculo][viagem.tipo].push(viagem);
            });
            
            // Calcular total geral
            let totalGeral = 0;
            
            // Criar seção para cada veículo
            for (const veiculo in veiculos) {
                const veiculoSection = document.createElement('div');
                veiculoSection.className = 'veiculo-card';
                
                const titulo = document.createElement('h3');
                titulo.className = 'veiculo-title';
                titulo.innerHTML = `<i class="fas fa-truck"></i> ${veiculo}`;
                veiculoSection.appendChild(titulo);
                
                // Seção de IDA
                if (veiculos[veiculo].ida.length > 0) {
                    const idaTitle = document.createElement('h4');
                    idaTitle.className = 'viagem-type';
                    idaTitle.innerHTML = '<i class="fas fa-arrow-right"></i> Viagens de Ida';
                    veiculoSection.appendChild(idaTitle);
                    
                    const idaTable = criarTabelaViagens(veiculos[veiculo].ida);
                    veiculoSection.appendChild(idaTable);
                    
                    // Calcular subtotal
                    const subtotalIda = veiculos[veiculo].ida.reduce((sum, viagem) => sum + viagem.valor, 0);
                    totalGeral += subtotalIda;
                    
                    const subtotalElement = document.createElement('p');
                    subtotalElement.className = 'total';
                    subtotalElement.textContent = `Subtotal Ida: R$ ${subtotalIda.toFixed(2).replace('.', ',')}`;
                    veiculoSection.appendChild(subtotalElement);
                }
                
                // Seção de VOLTA
                if (veiculos[veiculo].volta.length > 0) {
                    const voltaTitle = document.createElement('h4');
                    voltaTitle.className = 'viagem-type';
                    voltaTitle.innerHTML = '<i class="fas fa-arrow-left"></i> Viagens de Volta';
                    veiculoSection.appendChild(voltaTitle);
                    
                    const voltaTable = criarTabelaViagens(veiculos[veiculo].volta);
                    veiculoSection.appendChild(voltaTable);
                    
                    // Calcular subtotal
                    const subtotalVolta = veiculos[veiculo].volta.reduce((sum, viagem) => sum + viagem.valor, 0);
                    totalGeral += subtotalVolta;
                    
                    const subtotalElement = document.createElement('p');
                    subtotalElement.className = 'total';
                    subtotalElement.textContent = `Subtotal Volta: R$ ${subtotalVolta.toFixed(2).replace('.', ',')}`;
                    veiculoSection.appendChild(subtotalElement);
                }
                
                container.appendChild(veiculoSection);
            }
            
            // Adicionar total geral
            const totalElement = document.createElement('div');
            totalElement.className = 'total';
            totalElement.innerHTML = `<h3>Total Geral: R$ ${totalGeral.toFixed(2).replace('.', ',')}</h3>`;
            container.appendChild(totalElement);
        }

        // Criar tabela de viagens
        function criarTabelaViagens(viagens) {
            const table = document.createElement('table');
            
            // Cabeçalho
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            [
                { text: 'Data', icon: 'calendar-alt' },
                { text: 'Motorista', icon: 'user-tie' },
                { text: 'Colaborador', icon: 'users' },
                { text: 'Origem', icon: 'map-marker-alt' },
                { text: 'Destino', icon: 'map-marker' },
                { text: 'Cliente', icon: 'building' },
                { text: 'Valor', icon: 'money-bill-wave' },
                { text: 'Obs', icon: 'sticky-note' },
                { text: 'Ações', icon: 'cog' }
            ].forEach(col => {
                const th = document.createElement('th');
                th.innerHTML = `<i class="fas fa-${col.icon}"></i> ${col.text}`;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Corpo
            const tbody = document.createElement('tbody');
            viagens.forEach(viagem => {
                const row = document.createElement('tr');
                
                [
                    formatarData(viagem.data), 
                    viagem.motorista, 
                    viagem.colaborador,
                    viagem.origem, 
                    viagem.destino, 
                    viagem.cliente, 
                    `R$ ${viagem.valor.toFixed(2).replace('.', ',')}`,
                    viagem.observacoes || '-'
                ].forEach(text => {
                    const td = document.createElement('td');
                    td.textContent = text;
                    row.appendChild(td);
                });
                
                // Adicionar coluna de ações
                const actionsTd = document.createElement('td');
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'action-buttons';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-warning action-btn';
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.title = 'Editar';
                editBtn.onclick = () => editarViagem(viagem.id);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger action-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteBtn.title = 'Excluir';
                deleteBtn.onclick = () => excluirViagem(viagem.id);
                
                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);
                actionsTd.appendChild(actionsDiv);
                row.appendChild(actionsTd);
                
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            
            return table;
        }

        // Carregar dados ao iniciar
        document.addEventListener('DOMContentLoaded', function() {
            carregarViagens();
        });
    </script>
</body>
</html>
